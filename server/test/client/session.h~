#pragma once

#include <cstdint>
#include <memory>
#include "tateyama/transport/transport.h"
#include "tateyama/proto/debug/request.pb.h"
#include "tateyama/proto/debug/response.pb.h"

namespace tateyama {

class session {
public:
    session() {
        transport_ = std::make_unique<tateyama::bootstrap::wire::transport>(tateyama::bootstrap::wire::transport::service_id_debug);
    }
    ~session() {
        dispose();
        transport_.reset();
    }
    std::size_t session_id() noexcept {
        try {
            ::tateyama::proto::debug::request::Request request{};
            (void) request.mutable_blob_relay_create_session();
            auto response_opt = transport_->send<::tateyama::proto::debug::response::BlobRelayCreateSession>(request);

            if (response_opt) {
                const auto& response = response_opt.value();
                switch(response.result_case()) {
                case ::tateyama::proto::debug::response::BlobRelayCreateSession::ResultCase::kSessionId:
                    session_id_ = response.session_id();
                    return session_id_;
                }
            }
        } catch (std::runtime_error &ex) {
            std::cerr << ex.what() << std::endl;
        }
        return -1;
    }
    void dispose() const noexcept {
        try {
            ::tateyama::proto::debug::request::Request request{};
            (request.mutable_blob_relay_dispose_session())->set_session_id(session_id_);
            auto response_opt = transport_->send<::tateyama::proto::debug::response::BlobRelayDisposeSession>(request);

            if (response_opt) {
                const auto& response = response_opt.value();
                switch(response.result_case()) {
                case ::tateyama::proto::debug::response::BlobRelayDisposeSession::ResultCase::kSuccess:
                    return;
                }
            }
        } catch (std::runtime_error &ex) {
            std::cerr << ex.what() << std::endl;
        }
        return;
    }

private:
    std::unique_ptr<tateyama::bootstrap::wire::transport> transport_{};
    std::uint64_t session_id_{};
};

}  // namespace
